library(circular)
library(dplyr)
library(ggplot2)
library(mvtnorm)
library(posterior)
library(bayesplot)
library(latex2exp)
color_scheme_set("brightblue")

theme_set(theme_bw())

source("R/analysis_helpers.R")
source("R/linear-reg-sim/simulation_results_analysis_funcs.R")
source("R/linear-reg-sim/generate_data_for_linear_regression.R")

################################################################

#| label: fig-poor-fit-c-l-reg
#| echo: false
#| fig-cap: An example of an absent linear relationship between $\theta_i \overset{iid}{\sim} M(0, 25)$ and $X \overset{iid}{\sim} N(0,1)$ where $\theta_i$ and $X_i$ are mutually independent.

theta <- circular::rvonmises(100, circular::circular(0), 25)
X <- rnorm(100)

fit <- lm(theta ~ X)

plot(X, theta, pch = 16, ylab = latex2exp::TeX("$\\theta$"))
lines(X, predict(fit))

#| label: fig-pnreg-imps
#| fig-cap: "Imputations for data generated by the projected normal regression of $\\theta$ on $(X_1, X_2)$ and normal regression of $Y$ on $(X_1, X_2, \\cos \\theta, \\sin \\theta)$. Visualized here as the inversions to the circular interval by $\\\theta = \\tan^{-1}(\\sin\\theta, \\cos\\theta)$. Red points represent the masked angular values in the upper left plot while the colorful points represent imputed values in the other five plots."
#| out-width: 85% 

beta <- c(10, 2, 0.5, 0)
alphas <- list("MAR" = c(0,0,0,0,0,10))
fig_fps <- fig_file_paths("angle_from_pn_reg/0.5_missing_MAR", simQ = 100, M = 10, N = 100,
                          gamma = 0.25, theta_reg = TRUE,  mu = c(10, 0), Sigma = c(1, 0, 0, 1), 
                          beta = beta, alpha = alphas[["MAR"]])

knitr::include_graphics(c(fig_fps[["imp_by_y"]]))

# beta <- matrix(c(0,0, -7, 6, 
#                  10, 2, 0.5, 0), nrow = 2, byrow = T)
# alphas <- list("MAR" = c(0,0,0,0,0,10))
# sim_names <- c("angle_from_pn_mu_10_0", 
#                "angle_from_pn_mu_1_0",
#                "angle_bi-modal",
#                "angle_from_pn_reg/0.5_missing_MAR",
#                "angle_from_wn_reg",
#                "angle_from_vm_reg")
# names_DGPs <- c("PN High Conc", "PN Low Conc",
#                 "PN Bi-modal", "PN Reg",
#                 "WN Reg", "vM Reg")

# theta_reg <- c(F, F, F, T, T, T)
# simQs <- c(500, 500, 100, 100, 100, 100)
# M <- c(50, 50, 10, 10, 10, 10)
# N <- rep(100, 6)
# gamma <- c(0.25, 0.5, 0.5, 0.5, 0.5, 0.5)
# mu <- c(10, 1, 0.5, 10, 10, 10)
# sigma_mat <- matrix(c(1,0,0,1,
#                       1,0,0,1,
#                       1,-2,-2,10,
#                       1,0,0,1,
#                       1,0,0,1,
#                       1,0,0,1), nrow = 6, byrow = T)

sim.settings <- read.csv("Sim_Results/Sim_Settings_big.csv", header = T)

# sim.settings %<>% filter(DGP_Name != "PN Bi modal")

res_list <- list()
for (i in 1:nrow(sim.settings)) {
    fps <- build_fp_list(sim_name = sim.settings[i, "DGP"], 
                         name_DGP = sim.settings[i, "DGP_Name"],
                         fps = list("MAR" = NA),
                         simQ = sim.settings[i, "simQ"],
                         M = sim.settings[i, "M"],
                         N = sim.settings[i, "N"], 
                         gamma = sim.settings[i, "p_miss"],
                         theta_reg = F,
                         mu = sim.settings[i, c("mu_1", "mu_2")],
                         Sigma = sim.settings[i, c("sigma_mat_1", "sigma_mat_2",
                                                   "sigma_mat_3", "sigma_mat_4")],
                         beta = sim.settings[i, c("beta_1", "beta_2", 
                                                  "beta_3", "beta_4")],
                         alphas = sim.settings[i,
                                               c("alpha_1", "alpha_2", "alpha_3",
                                                "alpha_4", "alpha_5", "alpha_6")])
    
    tmp <- load_simulation_results(fps, cca_only = FALSE)
    tmp$reg_relation <- ifelse(sim.settings[i, "beta_1"] == 0, "Simple", "Complex")
    tmp <- tmp %>% select(-c(starts_with("r_"), starts_with("MISSTYPE")))
    tmp <- tmp %>% mutate(DGP = sim.settings[i, "DGP_Name"],
                          beta_1_true = sim.settings[i, "beta_1"],
                          beta_2_true = sim.settings[i, "beta_2"],
                          beta_3_true = sim.settings[i, "beta_3"],
                          beta_4_true = sim.settings[i, "beta_4"])
    
    res_list[[i]] <- tmp
}
        

res <- bind_rows(res_list)

res_longer <- res %>% #filter(Analysis != "Norm theta") %>%
    group_by(Analysis, DGP, reg_relation, N, M, prop_miss) %>%
    mutate(
        beta_1_est = beta_hat_1,
        beta_2_est = beta_hat_2,
        beta_3_est = beta_hat_3,
        beta_4_est = beta_hat_4,
        
        beta_1_MoE = MoE_1,
        beta_2_MoE = MoE_2,
        beta_3_MoE = MoE_3,
        beta_4_MoE = MoE_4,
        
        beta_1_CI_LB = beta_hat_1 - MoE_1,
        beta_1_CI_UB = beta_hat_1 + MoE_1,
        beta_2_CI_LB = beta_hat_2 - MoE_2,
        beta_2_CI_UB = beta_hat_2 + MoE_2,
        
        beta_3_CI_LB = beta_hat_3 - MoE_3,
        beta_3_CI_UB = beta_hat_3 + MoE_3,
        beta_4_CI_LB = beta_hat_4 - MoE_4,
        beta_4_CI_UB = beta_hat_4 + MoE_4,
    ) %>%
    select(-c(beta_1, beta_2, beta_3, beta_4,
              starts_with("beta_hat"),
              MoE_1, MoE_2, MoE_3, MoE_4, 
              pval, F_stat, starts_with("r_"))) %>%
    tidyr::pivot_longer(
        cols = starts_with("beta_"),
        names_to = c("Coef", "metric"),
        names_pattern = "beta_(.)_(.+)"
    ) %>%
    mutate(
        Coef = paste0("beta_", Coef)
    ) %>%
    tidyr::pivot_wider(
        names_from = metric,
        values_from = value,
        values_fn = list
    ) %>%
    tidyr::unnest_longer(data = ., col = c(true, est, MoE, CI_LB, CI_UB)) %>%
    arrange(Coef, Analysis)

summary(res_longer)

res_longer %>% filter(is.na(MoE), Coef == 'beta_4') %>%
    summarize(
        NA_count = sum(is.na(MoE))
    )

smry <- res_longer %>% filter(!is.na(MoE)) %>%
    group_by(DGP, Analysis, reg_relation, Coef, N, M, prop_miss) %>%
    summarize(
        n_sims = n(),
        mean_est = mean(est),
        bias = mean(est - true),
        mse = mean((est - true)^2),
        CI_width = mean(CI_UB - CI_LB),
        CI_Cov = mean(CI_LB <= true & CI_UB >= true) * 100,
        .groups = "keep"
    )

#| label: fig-ci-cov-sim-res
#| fig-cap: "95% confidence interval coverages for the linear covariates' regression coefficients $\\beta_1, \\beta_2$. The dotted horizontal line indicates the 90% confidence level and the solid line indicates 95% confidence."

ggplot(filter(res_longer,
              Analysis != "CCA",
              Analysis != "Complete",
              prop_miss == 0.5,
              DGP == "PN Low Conc"),
       aes(Analysis, median_imp_error, fill = as.factor(N))) +
    # geom_boxplot() +
    geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) +
    # geom_point(alpha = 0.1) +
    facet_grid(reg_relation~DGP, scales = "free") +
    # facet_grid(Coef ~ DGP) + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom")

ggplot(filter(res_longer,
              Analysis != "CCA",
              Analysis != "Complete",
              DGP == "PN Low Conc"),
       aes(Analysis, median_imp_error, fill = as.factor(N))) +
    # geom_boxplot() +
    geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) +
    facet_grid(reg_relation~as.factor(prop_miss), scales = "free") +
    # facet_grid(Coef ~ DGP) + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") +
    coord_cartesian(ylim = c(0, 3))

ggplot(filter(smry,
              Analysis != "Complete",
              N == 100,
              M == 50,
              reg_relation == "Complex"), 
       aes(Analysis, CI_Cov, fill = Analysis)) +
    geom_col(position = "dodge", color = "black") +
    facet_grid(Coef ~ DGP, scales = "free") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") +
    geom_hline(yintercept = 90, linetype = "dotted", color = "black") +
    geom_hline(yintercept = 95, linetype = "solid", color = "black") +
    labs(x = "Analysis", y = "95% CI Coverage", subtitle = "Complex")

ggplot(filter(smry,
              Analysis != "Complete",
              N == 100,
              M == 50,
              reg_relation == "Simple"), 
       aes(Analysis, CI_Cov, fill = Analysis)) +
    geom_col(position = "dodge", color = "black") +
    facet_grid(Coef ~ DGP, scales = "free") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") +
    geom_hline(yintercept = 90, linetype = "dotted", color = "black") +
    geom_hline(yintercept = 95, linetype = "solid", color = "black") +
    labs(x = "Analysis", y = "95% CI Coverage", subititle = "Simple")

ggplot(filter(smry,
              DGP == "PN Low Conc",
              N == 100), 
       aes(Analysis, CI_Cov, fill = as.factor(prop_miss))) +
    geom_col(position = "dodge", color = "black") +
    facet_grid(Coef ~ reg_relation, scales = "free") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") +
    geom_hline(yintercept = 90, linetype = "dotted", color = "black") +
    geom_hline(yintercept = 95, linetype = "solid", color = "black") +
    labs(x = "Analysis", y = "95% CI Coverage")

ggplot(filter(smry,
              DGP == "PN Low Conc",
              N == 100), 
       aes(Analysis, CI_width, fill = as.factor(prop_miss))) +
    geom_col(position = "dodge", color = "black") +
    facet_grid(Coef ~ reg_relation, scales = "free") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") +
    labs(x = "Analysis", y = "Avg 95% CI Width")



ggplot(filter(smry,
              DGP == "PN Low Conc",
              prop_miss == 0.5), 
       aes(Analysis, CI_width, fill = as.factor(N))) +
    geom_col(position = "dodge", color = "black") +
    facet_grid(Coef ~ reg_relation, scales = "free") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") +
    # geom_hline(yintercept = 90, linetype = "dotted", color = "black") +
    # geom_hline(yintercept = 95, linetype = "solid", color = "black") +
    labs(x = "Analysis", y = "Avg 95% CI Width")

# , "PN High Conc", "PN Bi-modal", "PN Skewed"


p1 <- ggplot(filter(res_longer,
                    DGP == "PN Low Conc",
                    N == 100),
       aes(Analysis, CI_UB - CI_LB, fill = as.factor(prop_miss))) + 
    # geom_hline(yintercept = 95, color = "darkgray", linetype = "dashed") +
    geom_boxplot() + 
    scale_color_viridis_c(option = "D", name = "Prop Missing") +
    scale_fill_viridis_d(option = "D", name = "Prop Missing") +
    facet_grid(Coef ~ reg_relation, scales = "free_y") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") + 
    labs(y = "95% CI Width")

p2 <- ggplot(filter(res_longer,
                    DGP == "PN Low Conc",
                    prop_miss == 0.5),
       aes(Analysis, CI_UB - CI_LB, fill = as.factor(N))) + 
    # geom_hline(yintercept = 95, color = "darkgray", linetype = "dashed") +
    geom_boxplot() + 
    scale_color_viridis_c(option = "D", name = "Sample Size (N)") +
    scale_fill_viridis_d(option = "D", name = "Sample Size (N)") +
    facet_grid(Coef ~ reg_relation, scales = "free_y") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") + 
    labs(y = "95% CI Width")

cowplot::plot_grid(p1, p2, nrow = 1, labels = c("a)", "b)"))

# ggplot(smry[which(smry$DGP == "PN Reg"),], 
#        aes(reg_relation, bias, color = as.factor(N))) +
#     geom_hline(yintercept = 0, col = "darkgray",linetype = "dashed") +
#     geom_point() +
#     facet_grid(Analysis ~ Coef)
# 
# ggplot(smry[which(smry$DGP == "PN Reg"),], 
#        aes(reg_relation, mse, color = as.factor(N))) +
#     geom_hline(yintercept = 0, col = "darkgray",linetype = "dashed") +
#     geom_point() +
#     facet_grid(Analysis ~ Coef)
# 
# ggplot(smry[which(smry$DGP == "PN Reg"),], 
#        aes(reg_relation, CI_Cov, color = as.factor(N))) +
#     geom_hline(yintercept = 95, col = "darkgray",linetype = "dashed") +
#     geom_point() +
#     facet_grid(Analysis ~ Coef)



ggplot(filter(smry,
              prop_miss == 0.5,
              N == 100,
              reg_relation == "Simple"),
       aes(x = Analysis, y = CI_Cov, fill = CI_width)) +
    geom_col(position = "dodge", color = "black") +
    scale_fill_viridis_c(option = "D", name = "CI Width") +
    facet_grid(Coef ~ DGP, scales = "free") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "right") +
    geom_hline(yintercept = 90, linetype = "dotted", color = "black") +
    geom_hline(yintercept = 95, linetype = "solid", color = "black") +
    labs(x = "Analysis", y = "95% CI Coverage", subtitle = "Simple")

ggplot(filter(smry,
              DGP != "PN High Conc",
              reg_relation == "Complex",
              N == 100,
              prop_miss == 0.5), 
                aes(Analysis, CI_Cov, fill = CI_width)) +
    geom_col(position = "dodge", color = "black") +
    scale_fill_viridis_c(option = "D", name = "CI Width") +
    facet_grid(Coef ~ DGP, scales = "free") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "right") +
    geom_hline(yintercept = 90, linetype = "dotted", color = "black") +
    geom_hline(yintercept = 95, linetype = "solid", color = "black") +
    labs(x = "Analysis", y = "95% CI Coverage", subtitle = "Complex")

ggplot(filter(smry,
              # DGP != "PN High Conc",
              reg_relation == "Complex",
              N == 100,
              prop_miss == 0.5), 
       aes(CI_width, CI_Cov, color = as.factor(Analysis))) +
    geom_point(size = 3, alpha = .5) +
    ggrepel::geom_text_repel(aes(label = as.numeric(as.factor(Analysis)))) +
    # geom_text(aes(label = Analysis)) +
    facet_grid(Coef ~ DGP, scales = "free") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") +
    geom_hline(yintercept = 90, linetype = "dotted", color = "black") +
    geom_hline(yintercept = 95, linetype = "solid", color = "black") +
    scale_x_continuous(expand = expansion(mult = 0.5)) +
    labs(x = "Average CI Width", y = "95% CI Coverage")

ggplot(filter(smry,
              reg_relation == "Complex",
              N == 100,
              prop_miss == 0.5,
              DGP  %in% c("PN Low Conc", "PN Skewed", "PN Bi modal", "PN Reg", "vM Reg", "WN Reg")), 
       aes(CI_width, CI_Cov, color = as.factor(Analysis))) +
    geom_point(size = 3, alpha = .5) +
    ggrepel::geom_text_repel(aes(label = ifelse(as.numeric(as.factor(Analysis)) %in% c(1, 3, 8), Analysis, "")),
                             min.segment.length = 0.1, seed = 42, box.padding = 0.25,
                             force = 0.5, nudge_x = 0.25, direction = "y", hjust = 0, segment.size = 0.2, color = "black") +
    facet_grid(Coef ~ DGP, scales = "free") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") +
    geom_hline(yintercept = 90, linetype = "dotted", color = "black") +
    geom_hline(yintercept = 95, linetype = "solid", color = "black") +
    scale_x_continuous(expand = expansion(mult = 0.5)) +
    scale_color_viridis_d(option = "D", name = "Analysis") +
    labs(x = "Average CI Width", y = "95% CI Coverage") +
    guides(fill = guide_legend(override.aes = aes(label = "")))



ggplot(filter(res_longer,
              N == 100,
              prop_miss == 0.5,
              reg_relation == "Complex",
              DGP != "Test"),
       aes(Analysis, CI_UB - CI_LB, fill = Analysis)) + 
    # geom_hline(yintercept = 95, color = "darkgray", linetype = "dashed") +
    geom_boxplot() + 
    scale_color_viridis_c(option = "D") +
    scale_fill_viridis_d(option = "D") +
    facet_grid(Coef ~ DGP, scales = "free_y") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") +
    labs(x = "Analysis", y = "CI Width")

ggplot(filter(res_longer,
              N == 100,
              prop_miss == 0.5,
              reg_relation == "Complex",
              DGP != "Test",
              DGP != "PN High Conc"),
       aes(Analysis, CI_UB - CI_LB, fill = Analysis)) + 
    # geom_hline(yintercept = 95, color = "darkgray", linetype = "dashed") +
    geom_boxplot() + 
    scale_color_viridis_c(option = "D") +
    scale_fill_viridis_d(option = "D") +
    facet_grid(Coef ~ DGP, scales = "free_y") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "bottom") +
    labs(x = "Analysis", y = "CI Width")

#| label: fig-sinusoidal-association
#| fig-cap: "An example of a sinusoidal association between $\\theta \\sim PN((1,0)', I_2)$ and $Y | \\theta \\sim N(3 + \\cos \\theta - 2\\sin\\theta, 0.25)$."
sim_dat <- generate_data("PN", N = 250, sigma = .25, beta = c(0,0,1, -2), mu = c(1,0), sigma_mat = c(1,0,0,1))

GGally::ggpairs(sim_dat[,c("Y", "X1", "X2", "theta")],
                upper = list(continuous = "points", combo = "facethist", discrete = "facetbar"),
                lower = list(continuous = "cor", combo = "box_no_facet", discrete = "count"))

#| label: fig-complex-association
#| fig-cap: "An example of a more complex association between $\\theta \\sim PN((1,0)', I_2)$ and $Y | X_1, X_2, \\theta \\sim N(3 + 5X_1 + 2 X_2 + 0.5 \\cos \\theta - 0 \\times \\sin\\theta, 0.25)$."
sim_dat <- generate_data("PN", N = 250, sigma = .25, beta = c(5, 2, 0.5, 0), mu = c(1,0), sigma_mat = c(1,0,0,1))

GGally::ggpairs(sim_dat[,c("Y", "X1", "X2", "theta")],
                upper = list(continuous = "points", combo = "facethist", discrete = "facetbar"),
                lower = list(continuous ="cor", combo = "box_no_facet", discrete = "count"))

#| label: fig-complex-association
#| fig-cap: "An example of a more complex association between $\\theta \\sim PN((1,0)', I_2)$ and $Y | X_1, X_2, \\theta \\sim N(3 + 5X_1 + 2 X_2 + 0.5 \\cos \\theta - 0 \\times \\sin\\theta, 0.25)$."
sim_dat <- generate_data("PNreg", N = 250, sigma = .25, beta = c(5, 2, 0.5, 0), mu = c(1,0), sigma_mat = c(1,0,0,1))

GGally::ggpairs(sim_dat[,c("Y", "X1", "X2", "theta")],
                upper = list(continuous = "points", combo = "facethist", discrete = "facetbar"),
                lower = list(continuous ="cor", combo = "box_no_facet", discrete = "count"))

#| label: tbl-pn-lowconc-est-mse
#| tbl-cap: "The mean estimates and MSE for the regression coefficients with MI where data were generated under the low concentration projected normal DGP ($\\theta  \\sim PN((1,0)', I_2)$). The 'Simple' regression relationship is for $\\beta_1 = \\beta_2 = 0$ while the 'Complex' relationship has $\\beta_j \\neq 0$ for $j = 1,2$."

print_mean_mse_table(smry, "PN Low Conc")
print_bias_table(smry, "PN Low Conc")

#| label: tbl-pn-highconc-est-mse
#| tbl-cap: "The mean estimates and MSE for the regression coefficients with MI where data were generated under the high concentration projected normal DGP ($\\theta  \\sim PN((10,0)', I_2)$). The 'Simple' regression relationship is for $\\beta_1 = \\beta_2 = 0$ while the 'Complex' relationship has $\\beta_j \\neq 0$ for $j = 1,2$."

print_mean_mse_table(smry, "PN High Conc")
print_bias_table(smry, "PN High Conc")

#| label: tbl-pn-reg-est-mse
#| tbl-cap: "The mean estimates and MSE for the regression coefficients with MI where data were generated under the projected normal regression DGP ($\\theta | X_1, X_2 \\sim PN(\\mu_i, I_2)$). The 'Simple' regression relationship is for $\\beta_1 = \\beta_2 = 0$ while the 'Complex' relationship has $\\beta_j \\neq 0$ for $j = 1,2$."

print_mean_mse_table(smry, "PN Reg")
print_bias_table(smry, "PN Reg")

#| label: fig-vmreg-dgp-ci-widths
#| fig-cap: "95% CI widths for the coefficient estimates from anglular data generated by the von Mises regression DGP."

ggplot(filter(smry,
              DGP == "vM Reg",
              Analysis != "Complete"),
       aes(reg_relation, CI_width, fill = Analysis)) +
    geom_col(color = "black", position = "dodge")  +
    facet_grid(Coef~., scales = "free") + 
    theme(axis.text.x = element_text(angle = 45, hjust =1),
          legend.position = "right") +
    labs(x = "Regression Relationship", y = "Average 95% CI Widths")

print_mean_mse_table(smry, "vM Reg")
print_bias_table(smry, "vM Reg")
